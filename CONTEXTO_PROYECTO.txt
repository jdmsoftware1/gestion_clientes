# CONTEXTO COMPLETO DEL PROYECTO - GESTI√ìN DE CLIENTES
# =====================================================================
# Fecha: 17 de Octubre 2025 - ACTUALIZADO CON ANALYTICS AVANZADOS
# Sistema: Gesti√≥n de Clientes con Dashboard + Analytics Empresariales
# Stack: Node.js + Express + React + PostgreSQL + Sequelize + Chart.js

# =====================================================================
# üöÄ PROMPT COMPLETO PARA REGENERAR EL PROYECTO
# =====================================================================

"""
Necesito que crees un sistema completo de gesti√≥n de clientes para una empresa de cobros con m√∫ltiples vendedores. Las caracter√≠sticas espec√≠ficas son:

## CONTEXTO DEL NEGOCIO:
- Empresa de cobros con 6 vendedores (Bego, David, Yaiza, BegoJi, fe, Jimenez)
- Cada vendedor tiene clientes asignados con deudas pendientes
- Se registran ventas (deudas) y pagos de los clientes
- Necesitan an√°lisis de rendimiento por vendedor y per√≠odo
- Sistema de cierres mensuales para an√°lisis hist√≥rico

## STACK TECNOL√ìGICO OBLIGATORIO:
- **Backend**: Node.js + Express.js + Sequelize ORM
- **Frontend**: React + Material-UI (MUI)
- **Base de datos**: PostgreSQL
- **Gr√°ficos**: Chart.js + react-chartjs-2
- **Fechas**: Transformaci√≥n autom√°tica snake_case ‚Üî camelCase

## MODELOS DE DATOS ESPEC√çFICOS:

### Salesperson (Vendedores):
- id (UUID), name, email, created_at, updated_at

### Client (Clientes):
- id (UUID), internalCode, name, phone, email, address
- salespersonId (FK), created_at, updated_at

### Sale (Ventas/Deudas):
- id (UUID), amount (DECIMAL), description
- clientId (FK), created_at, updated_at

### Payment (Pagos):
- id (UUID), amount (DECIMAL), description
- clientId (FK), created_at, updated_at

### MonthClosure (Cierres Mensuales):
- id (UUID), name, dateFrom, dateTo, salespersonId (nullable)
- totalSales, totalPayments, totalDebt, netAmount
- description, closedBy, created_at, updated_at

## FUNCIONALIDADES CORE REQUERIDAS:

### 1. DASHBOARD B√ÅSICO:
- KPIs: Deuda Total, Ventas per√≠odo, Pagos per√≠odo, Neto
- Rankings de Vendedores (por ventas)
- Rankings de Cobradores (por pagos)
- Filtros por fecha (√öltimos 30 d√≠as, personalizado, cierres guardados)
- Filtros por vendedor (contexto global)
- Listas de morosos y oportunidades con b√∫squeda y filtros

### 2. GESTI√ìN DE DATOS:
- CRUD completo de clientes, ventas y pagos
- Importaci√≥n masiva de datos desde archivos
- Sistema de cierres mensuales
- Bater√≠a de tests para verificar funcionamiento

### 3. AN√ÅLISIS AVANZADOS (SEPARADO DEL DASHBOARD B√ÅSICO):
- Gr√°ficos de tendencias temporales (Chart.js)
- Comparativas entre vendedores
- Distribuci√≥n de deuda por rangos
- KPIs avanzados: tasa conversi√≥n, tiempo cobro, eficiencia
- An√°lisis de rentabilidad con ROI y comisiones
- Identificaci√≥n de deuda irrecuperable con scoring
- Sistema de alertas inteligentes con filtros
- An√°lisis predictivo b√°sico con scoring de probabilidad de pago
- Modo demo/real h√≠brido para presentaciones

## CARACTER√çSTICAS T√âCNICAS CR√çTICAS:

### Problema de Fechas (DEBE SOLUCIONARSE):
- Sequelize devuelve fechas como `created_at` (snake_case)
- Frontend React espera `createdAt` (camelCase)
- **Soluci√≥n**: Utilidad `transformDatesForFrontend()` en controllers
- Aplicar en saleController.js y paymentController.js

### Datos Simulados:
- Crear ~300 clientes con deudas iniciales
- 293 ventas simuladas con descripci√≥n "Deuda inicial - [NOMBRE]"
- **IMPORTANTE**: Todas las ventas simuladas en fecha fija 31/12/2024
- Total deudas simuladas: ~‚Ç¨88,114.49
- Distribuir entre los 6 vendedores proporcionalmente

### Filtros de Fecha:
- Dashboard debe inicializar con √∫ltimos 30 d√≠as REALES (no fechas vac√≠as)
- Bot√≥n "√öltimos 30 d√≠as" debe calcular fechas (hoy - 30 d√≠as hasta hoy)
- Filtros servidor deben incluir todo el d√≠a (dateToEnd = dateTo + ' 23:59:59')
- Cierres globales (salespersonId null) deben aparecer para todos los vendedores

### Contexto de Vendedor:
- SalespersonContext global con opci√≥n "TODOS"
- Todos los componentes respetan el vendedor seleccionado
- Filtros se aplican consistentemente en toda la aplicaci√≥n

## ESTRUCTURA DE ARCHIVOS ESPEC√çFICA:

### Backend:
```
controllers/
‚îú‚îÄ‚îÄ dashboardController.js (KPIs b√°sicos, rankings)
‚îú‚îÄ‚îÄ analyticsController.js (an√°lisis avanzados - SEPARADO)
‚îú‚îÄ‚îÄ saleController.js (con transformaci√≥n fechas)
‚îú‚îÄ‚îÄ paymentController.js (con transformaci√≥n fechas)
‚îú‚îÄ‚îÄ monthClosureController.js (cierres globales)
‚îú‚îÄ‚îÄ clientController.js, importController.js

routes/
‚îú‚îÄ‚îÄ dashboard.js, analytics.js, sales.js, payments.js
‚îú‚îÄ‚îÄ clients.js, monthClosures.js, tests.js

utils/
‚îî‚îÄ‚îÄ transformDates.js (snake_case ‚Üí camelCase)

scripts/
‚îú‚îÄ‚îÄ updateSalesToPastDate.js (mover ventas a 31/12/2024)
‚îî‚îÄ‚îÄ createOctoberClosureSimple.js (crear cierres ejemplo)
```

### Frontend:
```
pages/
‚îú‚îÄ‚îÄ Dashboard.jsx (dashboard b√°sico estable)
‚îî‚îÄ‚îÄ Analytics.jsx (an√°lisis avanzados con tabs)

components/charts/
‚îú‚îÄ‚îÄ TrendChart.jsx (l√≠neas - Chart.js)
‚îú‚îÄ‚îÄ ComparisonChart.jsx (barras - Chart.js)
‚îú‚îÄ‚îÄ DebtDistributionChart.jsx (circular - Chart.js)
‚îî‚îÄ‚îÄ KPICard.jsx (tarjetas avanzadas)

api/
‚îú‚îÄ‚îÄ services.js (APIs b√°sicas)
‚îî‚îÄ‚îÄ analyticsAPI.js (APIs an√°lisis avanzados)

context/
‚îî‚îÄ‚îÄ SalespersonContext.js (vendedor global)
```

## ENDPOINTS API REQUERIDOS:
```
/api/dashboard/kpis
/api/dashboard/rankings
/api/dashboard/collectors
/api/analytics/kpis
/api/analytics/trends
/api/analytics/comparison
/api/analytics/profitability
/api/analytics/bad-debt
/api/sales, /api/payments, /api/clients
/api/month-closures, /api/tests
```

## COMANDOS DE INSTALACI√ìN:
```bash
# Backend
npm init -y
npm install express cors dotenv sequelize pg bcryptjs jsonwebtoken

# Frontend
npx create-react-app frontend
cd frontend
npm install @mui/material @emotion/react @emotion/styled
npm install @mui/icons-material axios
npm install chart.js react-chartjs-2
```

## VALIDACIONES CR√çTICAS:
1. ‚úÖ Fechas llegan como `createdAt` al frontend
2. ‚úÖ Filtros "√öltimos 30 d√≠as" devuelven arrays vac√≠os (no hay ventas 2025)
3. ‚úÖ Ventas simuladas en 31/12/2024 no interfieren con filtros actuales
4. ‚úÖ Cierres globales aparecen en selector para todos los vendedores
5. ‚úÖ Rankings respetan filtros de fecha correctamente
6. ‚úÖ An√°lisis avanzados separados del dashboard b√°sico

## RESULTADO ESPERADO:
Sistema completo con dashboard b√°sico estable + an√°lisis avanzados modulares, datos simulados realistas, filtros funcionando correctamente, y preparado para registrar ventas/pagos reales sin afectar el funcionamiento existente.
"""

# =====================================================================

## DESCRIPCI√ìN DEL PROYECTO
Sistema de gesti√≥n de clientes para empresa de cobros con m√∫ltiples vendedores.
Permite gestionar clientes, ventas, pagos, y generar an√°lisis de rendimiento.

## ESTRUCTURA ACTUAL
```
backend/
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îú‚îÄ‚îÄ saleController.js (‚úÖ Fechas corregidas)
‚îÇ   ‚îú‚îÄ‚îÄ paymentController.js (‚úÖ Fechas corregidas)
‚îÇ   ‚îú‚îÄ‚îÄ dashboardController.js (‚úÖ Filtros corregidos)
‚îÇ   ‚îú‚îÄ‚îÄ monthClosureController.js (‚úÖ Cierres globales)
‚îÇ   ‚îú‚îÄ‚îÄ clientController.js
‚îÇ   ‚îú‚îÄ‚îÄ importController.js
‚îÇ   ‚îî‚îÄ‚îÄ analyticsController.js (üÜï NUEVO - An√°lisis avanzados)
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ Sale.js
‚îÇ   ‚îú‚îÄ‚îÄ Payment.js
‚îÇ   ‚îú‚îÄ‚îÄ Client.js
‚îÇ   ‚îú‚îÄ‚îÄ Salesperson.js
‚îÇ   ‚îî‚îÄ‚îÄ MonthClosure.js
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îî‚îÄ‚îÄ analytics.js (üÜï NUEVO)
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ transformDates.js (üÜï NUEVO - Conversi√≥n snake_case ‚Üí camelCase)
‚îî‚îÄ‚îÄ scripts/
    ‚îú‚îÄ‚îÄ updateSalesToPastDate.js (‚úÖ Ejecutado)
    ‚îî‚îÄ‚îÄ createOctoberClosureSimple.js (‚úÖ Ejecutado)

frontend/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Dashboard.jsx (‚úÖ Filtros de fecha corregidos)
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ analyticsAPI.js (üÜï NUEVO)
‚îÇ   ‚îî‚îÄ‚îÄ context/
‚îÇ       ‚îî‚îÄ‚îÄ SalespersonContext.js
```

## PROBLEMAS RESUELTOS

### 1. ‚úÖ PROBLEMA DE FECHAS "Invalid Date"
**Causa**: Sequelize devolv√≠a fechas como `created_at` (snake_case) pero frontend esperaba `createdAt` (camelCase)
**Soluci√≥n**: 
- Creada utilidad `transformDatesForFrontend()` en `/utils/transformDates.js`
- Aplicada en `saleController.js` y `paymentController.js`
- Fechas ahora llegan como `createdAt` y `updatedAt`

### 2. ‚úÖ VENTAS SIMULADAS EN FECHAS INCORRECTAS
**Problema**: 293 ventas simuladas distribuidas en octubre 2025, interfiriendo con filtros
**Soluci√≥n**: 
- Script `updateSalesToPastDate.js` movi√≥ todas las ventas a 31/12/2024
- Total: ‚Ç¨88,114.49 en deudas iniciales
- Ahora no interfieren con filtros de fechas actuales

### 3. ‚úÖ FILTROS DE FECHA NO FUNCIONABAN
**Problema**: Bot√≥n "√öltimos 30 d√≠as" establec√≠a fechas vac√≠as, mostrando todos los datos
**Soluci√≥n**:
- Corregido `handleResetPeriod()` para calcular fechas reales (hoy - 30 d√≠as)
- Inicializaci√≥n de fechas con valores reales en lugar de strings vac√≠os
- Filtros de servidor corregidos para incluir todo el d√≠a (23:59:59)

### 4. ‚úÖ SELECTOR DE CIERRES NO MOSTRABA CIERRES GLOBALES
**Problema**: Cierres con `salespersonId: null` no aparec√≠an al filtrar por vendedor
**Soluci√≥n**: 
- Modificado `monthClosureController.js` con `Op.or` para incluir cierres globales
- Ahora muestra cierres espec√≠ficos del vendedor + cierres globales

## DATOS ACTUALES
- **Vendedores**: 6 (Bego, David, Yaiza, BegoJi, fe, Jimenez)
- **Clientes**: ~300 con deudas iniciales
- **Ventas simuladas**: 293 ventas en 31/12/2024 (‚Ç¨88,114.49 total)
- **Cierres de mes**: 2 disponibles ("Octubre" y "Primer Cierre Octubre")
- **Pagos**: 0 (sistema preparado para registrar pagos reales)

## FUNCIONALIDADES ACTUALES
‚úÖ Dashboard con KPIs b√°sicos (Deuda Total, Ventas, Pagos, Neto)
‚úÖ Rankings de Vendedores y Cobradores
‚úÖ Filtros por fecha (√öltimos 30 d√≠as, personalizado, cierres guardados)
‚úÖ Filtros por vendedor
‚úÖ Gesti√≥n de clientes (CRUD)
‚úÖ Gesti√≥n de ventas y pagos
‚úÖ Importaci√≥n de datos
‚úÖ Cierres de mes
‚úÖ Bater√≠a de tests del dashboard

## MEJORAS SOLICITADAS (EN PROGRESO)
El usuario pidi√≥ implementar TODAS las siguientes mejoras de forma ordenada:

### üìä 1. GR√ÅFICOS VISUALES CON CHART.JS
- Tendencias temporales (ventas/pagos por d√≠a/semana/mes)
- Comparativas entre vendedores
- Distribuci√≥n de deuda por rangos
- Gr√°ficos de barras, l√≠neas, circulares

### üí∞ 2. AN√ÅLISIS DE RENTABILIDAD
- ROI por vendedor
- Margen de beneficio
- Flujo de caja predictivo
- An√°lisis de deuda irrecuperable

### üîî 3. SISTEMA DE ALERTAS INTELIGENTES
- Clientes con deuda > X d√≠as sin pagar
- Vendedores con rendimiento bajo
- Metas no alcanzadas
- Oportunidades de cobro prioritarias

### üìà 4. AN√ÅLISIS PREDICTIVO B√ÅSICO
- Predicci√≥n de ventas futuras
- Probabilidad de cobro por cliente
- Identificaci√≥n de estacionalidad
- Scoring de riesgo de impago

### üéØ 5. GESTI√ìN DE OBJETIVOS
- Metas mensuales por vendedor
- Seguimiento en tiempo real
- Sistema de gamificaci√≥n
- C√°lculo autom√°tico de bonificaciones

### üìã 6. REPORTES EJECUTIVOS
- Informes autom√°ticos por email
- Dashboard ejecutivo para gerencia
- Reportes personalizados por rol
- Exportaci√≥n a Excel/PDF

## ESTADO ACTUAL DE IMPLEMENTACI√ìN
üü¢ **COMPLETADO**:
- Estructura modular para an√°lisis avanzados
- Controller `analyticsController.js` con KPIs avanzados
- API endpoints para an√°lisis (`/api/analytics/*`)
- M√©tricas implementadas:
  * Tasa de conversi√≥n (% clientes que pagan)
  * Tiempo promedio de cobro
  * Eficiencia por vendedor (ventas/d√≠a)
  * Distribuci√≥n de deuda por rangos
  * Datos para gr√°ficos de tendencias
  * Comparaci√≥n entre vendedores

üü° **EN PROGRESO**:
- Implementaci√≥n de gr√°ficos visuales con Chart.js

üî¥ **PENDIENTE**:
- Frontend para an√°lisis avanzados
- Sistema de alertas
- An√°lisis predictivo
- Gesti√≥n de objetivos
- Reportes ejecutivos

## TECNOLOG√çAS UTILIZADAS
- **Backend**: Node.js, Express.js, Sequelize ORM
- **Frontend**: React, Material-UI (MUI)
- **Base de datos**: PostgreSQL
- **Autenticaci√≥n**: Contexto de vendedor
- **Fechas**: Transformaci√≥n autom√°tica snake_case ‚Üî camelCase
- **An√°lisis**: SQL queries optimizadas para m√©tricas

## COMANDOS IMPORTANTES EJECUTADOS
```bash
# Mover ventas simuladas a fecha fija
node scripts/updateSalesToPastDate.js

# Crear cierre de octubre con ventas distribuidas
node scripts/createOctoberClosureSimple.js

# Verificar filtros de fecha
node scripts/testDateFilters.js
```

## ENDPOINTS API DISPONIBLES
```
/api/dashboard/kpis
/api/dashboard/rankings
/api/dashboard/collectors
/api/analytics/kpis (üÜï NUEVO)
/api/analytics/trends (üÜï NUEVO)
/api/analytics/comparison (üÜï NUEVO)
/api/sales
/api/payments
/api/clients
/api/month-closures
/api/tests
```

## PR√ìXIMOS PASOS
1. Continuar con implementaci√≥n de gr√°ficos Chart.js
2. Crear componentes React para an√°lisis avanzados
3. Implementar sistema de alertas
4. Desarrollar an√°lisis predictivo
5. Crear gesti√≥n de objetivos
6. Implementar reportes ejecutivos

## NOTAS IMPORTANTES
- Las ventas simuladas est√°n en 31/12/2024 para no interferir con an√°lisis actuales
- Los filtros de fecha funcionan correctamente para per√≠odos sin datos (devuelven arrays vac√≠os)
- El sistema est√° preparado para registrar ventas y pagos reales con fechas correctas
- Todos los cambios est√°n separados del c√≥digo estable existente
